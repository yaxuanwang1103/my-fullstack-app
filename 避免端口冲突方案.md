# 🔧 避免端口冲突的完整方案

## 📋 问题总结

你遇到的问题：**端口被占用导致 Docker 无法启动**

常见占用端口的进程：
- 🔴 本地 PostgreSQL 服务（占用 5432）
- 🔴 其他开发项目（占用 3000, 4000, 5173）
- 🔴 系统服务或后台程序

---

## ✅ 解决方案汇总

### 🎯 方案 1: 使用自动化脚本（最推荐）

**优点：**
- ✅ 一键启动，自动处理冲突
- ✅ 无需手动操作
- ✅ 适合日常使用

**使用方法：**
```
双击 start-docker.bat
```

**脚本功能：**
1. 自动检测端口占用
2. 自动停止占用进程
3. 启动 Docker 容器
4. 显示访问地址

---

### 🎯 方案 2: 修改端口配置（一劳永逸）

**优点：**
- ✅ 永久解决冲突
- ✅ 不影响其他服务

**已实施的修改：**

| 服务 | 原端口 | 新端口 | 原因 |
|------|--------|--------|------|
| PostgreSQL | 5432 | **5433** | 避免与本地 PostgreSQL 冲突 |
| 前端 | 5175 | **5173** | 统一端口 |
| 后端A | 3000 | 3000 | 保持不变 |
| 后端B | 4000 | 4000 | 保持不变 |

**如果还需要修改：**

编辑 `docker-compose.yml`：
```yaml
services:
  postgres:
    ports:
      - "新端口:5432"  # 例如 "5434:5432"
  
  frontend:
    ports:
      - "新端口:5173"  # 例如 "5174:5173"
```

---

### 🎯 方案 3: 停止本地服务（推荐）

**适用场景：** 本地 PostgreSQL 不常用

**Windows 停止 PostgreSQL 服务：**

```powershell
# 方法1: 使用 PowerShell
Stop-Service postgresql*

# 方法2: 禁用自动启动
Set-Service -Name postgresql* -StartupType Disabled

# 方法3: 使用服务管理器
services.msc
# 找到 PostgreSQL，右键 → 停止
```

**macOS/Linux:**
```bash
# macOS
brew services stop postgresql

# Linux
sudo systemctl stop postgresql
```

---

### 🎯 方案 4: 使用 Docker 网络隔离

**优点：**
- ✅ 完全隔离
- ✅ 不占用宿主机端口

**修改 docker-compose.yml：**

```yaml
# 不暴露端口到宿主机（仅容器间通信）
postgres:
  # 删除或注释掉 ports 配置
  # ports:
  #   - "5433:5432"
  networks:
    - todoapp-network
```

**注意：** 这样做后无法从 DBeaver 等工具直接连接，只能通过 Docker 内部访问。

---

### 🎯 方案 5: 使用环境变量动态端口

**创建 .env 文件：**

```env
# 端口配置
FRONTEND_PORT=5173
BACKEND_A_PORT=3000
BACKEND_B_PORT=4000
POSTGRES_PORT=5433
```

**修改 docker-compose.yml：**

```yaml
services:
  postgres:
    ports:
      - "${POSTGRES_PORT}:5432"
  
  backend-b:
    ports:
      - "${BACKEND_B_PORT}:4000"
  
  backend-a:
    ports:
      - "${BACKEND_A_PORT}:3000"
  
  frontend:
    ports:
      - "${FRONTEND_PORT}:5173"
```

**好处：** 可以轻松修改端口而不改动 docker-compose.yml

---

## 🛠️ 实用工具

### 1. 端口检查工具

**已创建的脚本：**
- `check-ports.bat` - 检查所有项目端口
- `start-docker.ps1` - 高级启动脚本（交互式）
- `start-docker.bat` - 快速启动脚本（自动化）
- `stop-docker.bat` - 停止脚本

### 2. 手动检查命令

```powershell
# Windows - 查看端口占用
netstat -ano | findstr :5433
netstat -ano | findstr :5173
netstat -ano | findstr :3000
netstat -ano | findstr :4000

# 查看进程详情
tasklist | findstr <PID>

# 停止进程
taskkill /F /PID <PID>
```

```bash
# macOS/Linux - 查看端口占用
lsof -i :5433
lsof -i :5173

# 停止进程
kill -9 <PID>
```

---

## 📊 推荐方案对比

| 方案 | 难度 | 效果 | 推荐度 | 适用场景 |
|------|------|------|--------|---------|
| 自动化脚本 | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 日常开发 |
| 修改端口 | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 永久解决 |
| 停止本地服务 | ⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | 不需要本地服务 |
| Docker 网络隔离 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | 高级用户 |
| 环境变量配置 | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 多环境部署 |

---

## 🎯 最佳实践

### 日常开发流程

```
1. 双击 start-docker.bat
   ↓
2. 脚本自动处理端口冲突
   ↓
3. 打开浏览器访问应用
   ↓
4. 开发完成后运行 stop-docker.bat
```

### 首次配置

```
1. 修改 docker-compose.yml 端口（已完成）
2. 停止本地 PostgreSQL 服务
3. 创建启动脚本（已完成）
4. 测试启动
```

### 遇到问题时

```
1. 运行 check-ports.bat 诊断
2. 查看哪个进程占用端口
3. 使用 start-docker.ps1 选择处理方式
4. 或手动停止占用进程
```

---

## 🔍 常见端口冲突场景

### 场景 1: PostgreSQL 冲突

**原因：** 本地安装了 PostgreSQL

**解决：**
```powershell
# 停止服务
Stop-Service postgresql*

# 或修改 Docker 端口为 5433（已完成）
```

### 场景 2: Node.js 项目冲突

**原因：** 其他项目占用 3000/4000 端口

**解决：**
```powershell
# 查找并停止
netstat -ano | findstr :3000
taskkill /F /PID <PID>

# 或使用 start-docker.bat 自动处理
```

### 场景 3: Vite 开发服务器冲突

**原因：** 其他 Vite 项目占用 5173

**解决：**
```powershell
# 停止其他 Vite 项目
# 或修改端口
```

---

## 📝 预防措施

### 1. 使用启动脚本

**始终使用 `start-docker.bat` 启动**，而不是直接运行 `docker-compose up`

### 2. 关闭不用的服务

```powershell
# 禁用 PostgreSQL 自动启动
Set-Service -Name postgresql* -StartupType Disabled
```

### 3. 使用唯一端口

为每个项目配置不同的端口：
- 项目A: 5173, 3000, 4000, 5433
- 项目B: 5174, 3001, 4001, 5434

### 4. 定期清理

```powershell
# 停止所有 Docker 容器
docker stop $(docker ps -aq)

# 清理未使用的容器
docker container prune
```

---

## 🚀 快速参考

### 启动项目
```
双击 start-docker.bat
```

### 检查端口
```
双击 check-ports.bat
```

### 停止项目
```
双击 stop-docker.bat
```

### 手动停止进程
```powershell
taskkill /F /PID <进程ID>
```

### 停止 PostgreSQL 服务
```powershell
Stop-Service postgresql*
```

---

## ✅ 总结

### 你现在拥有的工具

1. ✅ **自动化启动脚本** - `start-docker.bat`
2. ✅ **端口检查工具** - `check-ports.bat`
3. ✅ **停止脚本** - `stop-docker.bat`
4. ✅ **高级启动脚本** - `start-docker.ps1`
5. ✅ **修改后的端口配置** - PostgreSQL 使用 5433

### 推荐使用方式

**日常开发：**
```
直接双击 start-docker.bat，一键启动！
```

**遇到问题：**
```
1. 运行 check-ports.bat 诊断
2. 使用 start-docker.ps1 交互式处理
3. 查看文档手动解决
```

---

**现在你再也不用担心端口被占用的问题了！** 🎉

所有脚本都会自动处理端口冲突，让你专注于开发！

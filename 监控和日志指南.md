# 📊 监控和日志完整指南

## 📍 数据存储位置

### PostgreSQL 数据库

**连接信息：**
- Host: `localhost`
- Port: `5432`
- Database: `todoapp`
- Username: `postgres`
- Password: `postgres`

**查看数据：**

```bash
# 方法1：使用 Docker 命令
docker exec -it todoapp-postgres psql -U postgres -d todoapp

# 查看所有任务
SELECT * FROM messages ORDER BY "createdAt" DESC;

# 统计任务数量
SELECT COUNT(*) as total FROM messages;

# 按类别统计
SELECT category, COUNT(*) as count 
FROM messages 
GROUP BY category;

# 按优先级统计
SELECT priority, COUNT(*) as count 
FROM messages 
GROUP BY priority;

# 查看最近添加的任务
SELECT text, category, priority, "createdAt" 
FROM messages 
ORDER BY "createdAt" DESC 
LIMIT 10;
```

**使用可视化工具：**

推荐工具：
1. **DBeaver** (免费) - https://dbeaver.io/
2. **pgAdmin** (免费) - https://www.pgadmin.org/
3. **TablePlus** (付费) - https://tableplus.com/

---

## 📝 日志查看

### 本地 Docker 环境

#### 实时查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务
docker-compose logs -f backend-a
docker-compose logs -f backend-b
docker-compose logs -f frontend
docker-compose logs -f postgres

# 查看最近 N 行
docker-compose logs --tail=100 backend-a

# 查看特定时间段
docker-compose logs --since 2024-10-27T10:00:00 backend-a
docker-compose logs --since 30m backend-a  # 最近30分钟

# 同时查看多个服务
docker-compose logs -f backend-a backend-b
```

#### 保存日志到文件

```bash
# 保存所有日志
docker-compose logs > logs/all-logs.txt

# 保存特定服务日志
docker-compose logs backend-a > logs/backend-a.log

# 保存最近的日志
docker-compose logs --tail=1000 > logs/recent-logs.txt
```

#### 日志文件位置

**Windows:**
```
C:\ProgramData\Docker\containers\<container-id>\<container-id>-json.log
```

**查看容器 ID:**
```bash
docker ps
```

---

## 📊 访问统计（需要添加）

### 当前状态：未实现

你的项目目前**没有**访问统计功能。以下是实现方案：

### 方案 1：添加简单的访问日志

在后端添加中间件记录每次请求。

**backend-a/server.js 添加：**

```javascript
// 访问日志中间件
app.use((req, res, next) => {
  const timestamp = new Date().toISOString();
  const method = req.method;
  const url = req.url;
  const ip = req.ip || req.connection.remoteAddress;
  
  console.log(`[${timestamp}] ${method} ${url} - IP: ${ip}`);
  next();
});
```

### 方案 2：使用数据库记录访问

创建访问记录表：

```sql
CREATE TABLE access_logs (
  id SERIAL PRIMARY KEY,
  ip VARCHAR(50),
  method VARCHAR(10),
  url VARCHAR(255),
  user_agent TEXT,
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 方案 3：使用第三方服务

**推荐工具：**
1. **Google Analytics** - 免费，功能强大
2. **Plausible** - 隐私友好
3. **Umami** - 开源，可自托管

---

## 🔍 监控程序是否崩溃

### 本地开发环境

#### 检查容器状态

```bash
# 查看所有容器状态
docker-compose ps

# 查看容器健康状态
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# 检查容器是否在运行
docker inspect todoapp-backend-a --format='{{.State.Status}}'
```

#### 监控脚本

创建一个监控脚本 `monitor.sh`：

```bash
#!/bin/bash

while true; do
  echo "=== $(date) ==="
  
  # 检查容器状态
  docker-compose ps
  
  # 检查端口是否响应
  curl -f http://localhost:5173 > /dev/null 2>&1 && echo "✅ Frontend OK" || echo "❌ Frontend DOWN"
  curl -f http://localhost:3000/health > /dev/null 2>&1 && echo "✅ Backend-A OK" || echo "❌ Backend-A DOWN"
  curl -f http://localhost:4000/health > /dev/null 2>&1 && echo "✅ Backend-B OK" || echo "❌ Backend-B DOWN"
  
  echo ""
  sleep 60  # 每60秒检查一次
done
```

---

## 🚨 程序崩溃了怎么办？

### 步骤 1：查看容器状态

```bash
# 查看哪个容器崩溃了
docker-compose ps

# 查看崩溃容器的日志
docker-compose logs --tail=100 <service-name>
```

### 步骤 2：查看错误日志

```bash
# 查看最近的错误
docker-compose logs --tail=200 backend-a | grep -i error
docker-compose logs --tail=200 backend-a | grep -i exception

# 查看完整日志
docker-compose logs backend-a > crash-log.txt
```

### 步骤 3：重启服务

```bash
# 重启特定服务
docker-compose restart backend-a

# 重启所有服务
docker-compose restart

# 完全重新启动
docker-compose down
docker-compose up -d
```

### 步骤 4：查看系统资源

```bash
# 查看容器资源使用
docker stats

# 查看磁盘空间
docker system df

# 清理未使用的资源
docker system prune
```

---

## 📈 生产环境监控（AWS ECS）

### 查看 ECS 日志

```bash
# 使用 AWS CLI 查看日志
aws logs tail /ecs/todoapp-frontend --follow

# 查看特定时间段的日志
aws logs filter-log-events \
  --log-group-name /ecs/todoapp-backend-a \
  --start-time $(date -d '1 hour ago' +%s)000

# 搜索错误日志
aws logs filter-log-events \
  --log-group-name /ecs/todoapp-backend-a \
  --filter-pattern "ERROR"
```

### 在 AWS Console 查看

1. 打开 AWS Console
2. 进入 **CloudWatch** → **Log groups**
3. 找到你的日志组：
   - `/ecs/todoapp-frontend`
   - `/ecs/todoapp-backend-a`
   - `/ecs/todoapp-backend-b`
4. 点击查看日志流

### 设置告警

在 CloudWatch 中设置告警：

1. **CPU 使用率过高**
2. **内存使用率过高**
3. **错误日志数量激增**
4. **服务不可用**

---

## 🛠️ 推荐的监控工具

### 免费工具

1. **Grafana + Prometheus**
   - 功能强大
   - 可视化监控
   - 开源免费

2. **Uptime Kuma**
   - 简单易用
   - 监控服务可用性
   - 开源免费

3. **Netdata**
   - 实时监控
   - 自动安装
   - 开源免费

### 付费工具

1. **Datadog** - 全面的监控解决方案
2. **New Relic** - APM 性能监控
3. **Sentry** - 错误追踪

---

## 📊 实用查询命令

### 数据库统计

```sql
-- 总任务数
SELECT COUNT(*) FROM messages;

-- 今天新增的任务
SELECT COUNT(*) FROM messages 
WHERE DATE("createdAt") = CURRENT_DATE;

-- 本周新增的任务
SELECT COUNT(*) FROM messages 
WHERE "createdAt" >= DATE_TRUNC('week', CURRENT_DATE);

-- 按日期统计
SELECT DATE("createdAt") as date, COUNT(*) as count
FROM messages
GROUP BY DATE("createdAt")
ORDER BY date DESC;

-- 按小时统计（查看高峰期）
SELECT EXTRACT(HOUR FROM "createdAt") as hour, COUNT(*) as count
FROM messages
WHERE DATE("createdAt") = CURRENT_DATE
GROUP BY hour
ORDER BY hour;
```

### Docker 统计

```bash
# 查看容器资源使用
docker stats --no-stream

# 查看容器启动时间
docker inspect todoapp-backend-a --format='{{.State.StartedAt}}'

# 查看容器重启次数
docker inspect todoapp-backend-a --format='{{.RestartCount}}'

# 查看容器网络流量
docker stats --format "table {{.Container}}\t{{.NetIO}}"
```

---

## 🔧 添加健康检查

### Docker Compose 健康检查

在 `docker-compose.yml` 中添加：

```yaml
services:
  backend-a:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  
  backend-b:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

### 查看健康状态

```bash
# 查看健康状态
docker-compose ps

# 详细健康信息
docker inspect todoapp-backend-a --format='{{.State.Health.Status}}'
```

---

## 📱 实时监控脚本

创建 `monitor.ps1` (Windows PowerShell):

```powershell
while ($true) {
    Clear-Host
    Write-Host "=== 服务监控 $(Get-Date) ===" -ForegroundColor Green
    
    # 检查容器状态
    docker-compose ps
    
    # 检查服务响应
    try {
        $frontend = Invoke-WebRequest -Uri "http://localhost:5173" -UseBasicParsing -TimeoutSec 5
        Write-Host "✅ Frontend: OK" -ForegroundColor Green
    } catch {
        Write-Host "❌ Frontend: DOWN" -ForegroundColor Red
    }
    
    try {
        $backendA = Invoke-WebRequest -Uri "http://localhost:3000/health" -UseBasicParsing -TimeoutSec 5
        Write-Host "✅ Backend-A: OK" -ForegroundColor Green
    } catch {
        Write-Host "❌ Backend-A: DOWN" -ForegroundColor Red
    }
    
    try {
        $backendB = Invoke-WebRequest -Uri "http://localhost:4000/health" -UseBasicParsing -TimeoutSec 5
        Write-Host "✅ Backend-B: OK" -ForegroundColor Green
    } catch {
        Write-Host "❌ Backend-B: DOWN" -ForegroundColor Red
    }
    
    # 显示资源使用
    Write-Host "`n=== 资源使用 ===" -ForegroundColor Yellow
    docker stats --no-stream
    
    Start-Sleep -Seconds 60
}
```

运行：
```powershell
.\monitor.ps1
```

---

## 📋 快速参考

### 常用命令

```bash
# 查看日志
docker-compose logs -f

# 查看数据
docker exec -it todoapp-postgres psql -U postgres -d todoapp

# 检查状态
docker-compose ps

# 重启服务
docker-compose restart

# 查看资源
docker stats

# 清理日志
docker-compose logs --tail=0 > /dev/null
```

### 紧急情况处理

```bash
# 1. 查看哪个服务崩溃
docker-compose ps

# 2. 查看崩溃日志
docker-compose logs --tail=200 <service>

# 3. 重启服务
docker-compose restart <service>

# 4. 如果还不行，完全重启
docker-compose down
docker-compose up -d

# 5. 查看详细错误
docker-compose logs <service> | grep -i error
```

---

## 🎯 下一步建议

1. ✅ 创建监控脚本
2. ✅ 设置日志轮转
3. ✅ 添加访问统计
4. ✅ 配置告警通知
5. ✅ 定期备份数据库

---

需要我帮你实现任何监控功能吗？

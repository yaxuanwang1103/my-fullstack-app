# 🔌 端口配置说明

## 📋 所有服务端口

| 服务 | 端口 | 访问地址 | 说明 |
|------|------|---------|------|
| **前端** | 5173 | http://localhost:5173 | React + Vite 开发服务器 |
| **后端A** | 3000 | http://localhost:3000 | 智能分类服务 |
| **后端B** | 4000 | http://localhost:4000 | 数据存储服务 |
| **PostgreSQL** | **5433** | localhost:5433 | 数据库服务 |

---

## ⚠️ 重要说明：PostgreSQL 端口为 5433

### 为什么不是默认的 5432？

**原因：避免与本地 PostgreSQL 冲突**

如果你的电脑上已经安装了 PostgreSQL（很多开发者都会安装），它默认占用 5432 端口。为了避免端口冲突，本项目的 Docker PostgreSQL 使用 **5433** 端口。

---

## 🔧 端口映射说明

### docker-compose.yml 配置

```yaml
postgres:
  ports:
    - "5433:5432"
      ↑      ↑
   宿主机  容器内
```

**解释：**
- **容器内部**：PostgreSQL 运行在标准的 5432 端口
- **宿主机访问**：映射到 5433 端口
- **容器间通信**：其他容器通过 `postgres:5432` 访问（使用容器名）

---

## 📱 不同场景的连接方式

### 1. 从浏览器访问前端
```
http://localhost:5173
```

### 2. 从 DBeaver/pgAdmin 连接数据库
```
主机: localhost 或 127.0.0.1
端口: 5433  ← 注意！
数据库: todoapp
用户名: todouser
密码: todopass123
```

### 3. 从命令行连接数据库
```bash
# 通过 Docker
docker exec -it todoapp-postgres psql -U todouser -d todoapp

# 通过本地 psql（如果安装了）
psql -h localhost -p 5433 -U todouser -d todoapp
```

### 4. 从后端B代码连接数据库
```javascript
// 在 Docker 容器内，使用容器名和内部端口
const pool = new Pool({
  host: 'postgres',      // 容器名
  port: 5432,            // 容器内部端口
  database: 'todoapp',
  user: 'todouser',
  password: 'todopass123'
});
```

---

## 🔍 检查端口占用

### Windows PowerShell
```powershell
# 查看所有项目端口
netstat -ano | findstr :5173
netstat -ano | findstr :3000
netstat -ano | findstr :4000
netstat -ano | findstr :5433
```

### 查看具体进程
```powershell
# 查看占用端口的进程
Get-Process -Id (Get-NetTCPConnection -LocalPort 5433).OwningProcess
```

---

## 🛠️ 如果需要修改端口

### 修改 PostgreSQL 端口

编辑 `docker-compose.yml`：

```yaml
postgres:
  ports:
    - "你想要的端口:5432"  # 例如 "5434:5432"
```

然后重启：
```bash
docker-compose down
docker-compose up -d
```

### 修改其他服务端口

同样在 `docker-compose.yml` 中修改对应服务的 `ports` 配置。

---

## ✅ 端口冲突解决方案

### 如果 5433 也被占用了

**方案1：停止占用端口的进程**
```powershell
# 查找进程ID
netstat -ano | findstr :5433

# 停止进程（替换 PID）
taskkill /PID <进程ID> /F
```

**方案2：使用其他端口**
```yaml
# 改为 5434 或其他未占用的端口
postgres:
  ports:
    - "5434:5432"
```

**方案3：停止本地 PostgreSQL 服务**
```powershell
# 停止服务
Stop-Service postgresql*

# 禁用自动启动
Set-Service -Name postgresql* -StartupType Disabled
```

---

## 📊 端口使用总结

```
你的电脑
├── 浏览器 → localhost:5173 → 前端容器
├── DBeaver → localhost:5433 → PostgreSQL 容器
│
└── Docker 网络（容器间通信）
    ├── frontend → backend-a:3000
    ├── backend-a → backend-b:4000
    └── backend-b → postgres:5432
```

**关键点：**
- 外部访问使用宿主机端口（5433）
- 容器间通信使用容器名和内部端口（postgres:5432）

---

## 🎯 常见问题

### Q: 为什么容器内部还是 5432？
**A:** 容器内部的 PostgreSQL 不知道外部端口映射，它仍然在标准的 5432 端口监听。Docker 负责将外部的 5433 请求转发到容器内的 5432。

### Q: 我可以改回 5432 吗？
**A:** 可以，但前提是你的电脑上没有其他服务占用 5432 端口。如果有本地 PostgreSQL，需要先停止它。

### Q: 修改端口后需要重新构建镜像吗？
**A:** 不需要。端口映射只在 `docker-compose.yml` 中配置，修改后只需 `docker-compose down` 然后 `docker-compose up -d` 即可。

---

**最后更新：** 2024-10-25
**原因：** 避免与本地 PostgreSQL 端口冲突

name: CD - æŒç»­éƒ¨ç½²

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://your-app-url.com
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ éƒ¨ç½²ç‰ˆæœ¬: $VERSION"
      
      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /path/to/your/app || exit 1
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ³ æ‹‰å– Docker é•œåƒ..."
            docker-compose pull
            
            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker-compose down
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "â–¶ï¸ å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo "ğŸ“Š æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
            docker-compose ps
            
            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
      
      - name: ğŸ” å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥å‰ç«¯
          curl -f http://${{ secrets.SERVER_HOST }}:5173 || echo "âš ï¸ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
          
          # æ£€æŸ¥åç«¯A
          curl -f http://${{ secrets.SERVER_HOST }}:3000/health || echo "âš ï¸ åç«¯Aå¥åº·æ£€æŸ¥å¤±è´¥"
          
          # æ£€æŸ¥åç«¯B
          curl -f http://${{ secrets.SERVER_HOST }}:4000/health || echo "âš ï¸ åç«¯Bå¥åº·æ£€æŸ¥å¤±è´¥"
          
          echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"
      
      - name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å›æ»š"
          fi
  
  # å›æ»šä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  rollback:
    name: å›æ»šéƒ¨ç½²
    runs-on: ubuntu-latest
    if: failure()
    needs: deploy
    
    steps:
      - name: ğŸ”„ æ‰§è¡Œå›æ»š
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸ”„ å¼€å§‹å›æ»š..."
            cd /path/to/your/app
            git checkout HEAD~1
            docker-compose down
            docker-compose up -d
            echo "âœ… å›æ»šå®Œæˆ"

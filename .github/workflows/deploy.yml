name: CD - æŒç»­éƒ¨ç½²åˆ° AWS ECS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production

env:
  AWS_REGION: us-east-2  # ä¿®æ”¹ä¸ºä½ çš„AWSåŒºåŸŸ
  ECS_CLUSTER: todoapp-cluster
  
  # Backend A
  ECS_SERVICE_BACKEND_A: todoapp-backend-a
  ECS_TASK_DEFINITION_BACKEND_A: todoapp-backend-a
  CONTAINER_NAME_BACKEND_A: todoapp-backend-a
  
  # Backend B
  ECS_SERVICE_BACKEND_B: todoapp-backend-b
  ECS_TASK_DEFINITION_BACKEND_B: todoapp-backend-b
  CONTAINER_NAME_BACKEND_B: todoapp-backend-b
  
  # Frontend
  ECS_SERVICE_FRONTEND: todoapp-frontend
  ECS_TASK_DEFINITION_FRONTEND: todoapp-frontend
  CONTAINER_NAME_FRONTEND: todoapp-frontend

jobs:
  deploy:
    name: éƒ¨ç½²åˆ° AWS ECS
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ éƒ¨ç½²ç‰ˆæœ¬: $VERSION"
      
      - name: ğŸ” é…ç½® AWS å‡­è¯
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ”‘ ç™»å½•åˆ° Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: ğŸš€ éƒ¨ç½² Backend A åˆ° ECS
        run: |
          echo "ğŸš€ éƒ¨ç½² Backend A..."
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE_BACKEND_A }} \
            --task-definition ${{ env.ECS_TASK_DEFINITION_BACKEND_A }}:6 \
            --force-new-deployment
      
      - name: ğŸš€ éƒ¨ç½² Backend B åˆ° ECS
        run: |
          echo "ğŸš€ éƒ¨ç½² Backend B..."
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE_BACKEND_B }} \
            --task-definition ${{ env.ECS_TASK_DEFINITION_BACKEND_B }}:4 \
            --force-new-deployment
      
      - name: ğŸš€ éƒ¨ç½² Frontend åˆ° ECS
        run: |
          echo "ğŸš€ éƒ¨ç½² Frontend..."
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE_FRONTEND }} \
            --task-definition ${{ env.ECS_TASK_DEFINITION_FRONTEND }}:5 \
            --force-new-deployment
      
      - name: â³ ç­‰å¾… Backend A éƒ¨ç½²å®Œæˆ
        run: |
          echo "â³ ç­‰å¾… Backend A æœåŠ¡ç¨³å®š..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_BACKEND_A }}
          echo "âœ… Backend A éƒ¨ç½²å®Œæˆ"
      
      - name: â³ ç­‰å¾… Backend B éƒ¨ç½²å®Œæˆ
        run: |
          echo "â³ ç­‰å¾… Backend B æœåŠ¡ç¨³å®š..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_BACKEND_B }}
          echo "âœ… Backend B éƒ¨ç½²å®Œæˆ"
      
      - name: â³ ç­‰å¾… Frontend éƒ¨ç½²å®Œæˆ
        run: |
          echo "â³ ç­‰å¾… Frontend æœåŠ¡ç¨³å®š..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_FRONTEND }}
          echo "âœ… Frontend éƒ¨ç½²å®Œæˆ"
      
      - name: ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€
        run: |
          echo "ğŸ“Š æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€..."
          
          echo "Backend A çŠ¶æ€:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_BACKEND_A }} \
            --query 'services[0].[serviceName,status,runningCount,desiredCount]' \
            --output table
          
          echo "Backend B çŠ¶æ€:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_BACKEND_B }} \
            --query 'services[0].[serviceName,status,runningCount,desiredCount]' \
            --output table
          
          echo "Frontend çŠ¶æ€:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_FRONTEND }} \
            --query 'services[0].[serviceName,status,runningCount,desiredCount]' \
            --output table
      
      - name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.version }} å·²éƒ¨ç½²åˆ° ECS"
            echo "ğŸ“¦ Cluster: ${{ env.ECS_CLUSTER }}"
            echo "ğŸ”§ Services: Backend A, Backend B, Frontend"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶è€ƒè™‘å›æ»š"
          fi
